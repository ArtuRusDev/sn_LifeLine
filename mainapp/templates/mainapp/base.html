{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>{% block title %}Life on Line{% endblock %}</title>
    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Социальная сеть Life on Line - место где вы можете познакомиться и пообщаться с
    интересными людьми, найти единомышленников, объединиться в группы по интересам и поделиться новостями."/>

    <!-- LIBs -->
    <link href="{% static 'css/lib/bootstrap-4/bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'css/lib/bootstrap-4/bootstrap-grid.css' %}" rel="stylesheet">
    <link href="{% static 'css/lib/bootstrap-4/bootstrap-reboot.css' %}" rel="stylesheet">
    <link href="{% static 'css/lib/animate.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/lib/jquery.fancybox.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/lib/fontawesome/css/font-awesome.min.css' %}" rel="stylesheet">

    <!-- CSS -->
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>
<body>
<script src="{% static 'js/lib/jquery-3.2.1.min.js' %}"></script>

{% include 'mainapp/includes/inc_navbar.html' %}

<div class="container">
    {% block content %}{% endblock %}
</div>

{% if user.is_authenticated %}
<script src="{% static 'js/new_mess_count_update.js' %}"></script>
{% endif %}

<script src="{% static 'js/menu.js' %}"></script>
<script src="{% static 'js/news_actions.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
<!--<script src="{% static 'js/community_actions.js' %}"></script>-->

<script src="{% static 'js/lib/jquery.fancybox.min.js' %}"></script>

<script>
    const user_id = "{{ user.id }}";
    const profileSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/profile/' + user_id + '/'
    );

    profileSocket.onmessage = function (e) {
        let data = JSON.parse(e.data);

        if (data['event'] === 'notice') {
            if (typeof chatSocket !== 'undefined' && chat_id === data['chat_id']) {
                return;
            }

            if (data['obj'] === 'message') {
                if ($('.b-chats-list')[0]) {
                    update_chats();
                }

                let $notice = $('.js-new-msg-header-counter'),
                    cnt = $notice.attr('data-value'),
                    unread_chats = $notice.attr('data-chats').split(',');

                if (unread_chats.indexOf(data['chat_id']) !== -1) {
                    return;
                }

                unread_chats.push(data['chat_id']);
                cnt++;

                $notice[0].innerHTML = cnt;
                $notice.attr('data-value', cnt);
                $notice.attr('data-chats', unread_chats.join(','));
                $notice.removeClass('d-none');
            }
        }
    };

    profileSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    function update_chats() {
        $.ajax({
            url: "/dialogs/get/update_dialogs/",

            success: function (data) {
                if (data.result) {
                    $('.b-chats-list').html(data.result);
                }
            },

            failed: function () {
                console.log('ajax FAILED!');
            }
        });
    }
</script>
</body>
</html>